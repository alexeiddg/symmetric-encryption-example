# KeyEmbeddingService

Overview
--------

The `KeyEmbeddingService` class is responsible for embedding the number of encryption rounds directly into the encryption key matrix. Specifically, it encodes the number of rounds in the first byte of the matrix, ensuring that this information is carried along with the key for both encryption and decryption processes. This technique helps control the number of transformations applied to the data during the encryption process.

```
    private static final SecureRandom random = new SecureRandom();

    public KeyMatrix embedKey(KeyMatrix entropyKey) {
        byte[][] matrix = entropyKey.matrix();

        int randomInt = random.nextInt(16) + 1;
        byte randomByte = (byte) randomInt;
        matrix[0][0] = randomByte;

        return new KeyMatrix(matrix);
    }
```

Purpose and Role in the Encryption Service
------------------------------------------

-   **Embedding Encryption Round Information**: The service modifies the first byte of the key matrix to store the number of rounds to be used during encryption. This information is crucial for ensuring that the same number of rounds are applied during both encryption and decryption.
-   **Random Round Generation**: The number of rounds is generated randomly between 16 and 24, providing variability and complexity to the encryption process.
-   **Consistency Across Rounds**: By embedding the number of rounds directly into the key, the decryption service can easily extract this information to reverse the encryption process accurately.

Key Concepts
------------

-   **KeyMatrix**: A 4x4 matrix representing the encryption key, which stores the number of encryption rounds in the first byte.
-   **SecureRandom**: A Java class that generates cryptographically secure random numbers. Here, it is used to determine the number of encryption rounds, ensuring unpredictability and enhancing the security of the encryption process.
-   **Embedding the Rounds**: The first byte of the key matrix is overwritten with a randomly generated integer (between 1 and 16), representing the number of encryption rounds.

### `embedKey(KeyMatrix entropyKey)`

**Objective**: Embed the number of encryption rounds into the first byte of the 4x4 `KeyMatrix`.

### Process:

1.  **Extract the Matrix**:
    -   The method accesses the byte array (`matrix`) within the `KeyMatrix`, a 4x4 byte matrix that represents the encryption key.
2.  **Generate a Random Number of Rounds**:
    -   Using the `SecureRandom` class, the method generates a cryptographically secure random integer between 1 and 16. This number represents the number of rounds the encryption service will perform.
3.  **Embed the Number of Rounds**:
    -   The first byte of the matrix (`matrix[0][0]`) is set to the randomly generated byte value, which represents the number of encryption rounds.
    -   The rest of the matrix remains unchanged, preserving the core of the encryption key.
4.  **Return the Updated Matrix**:
    -   A new `KeyMatrix` object is created and returned, with the first byte of the matrix containing the number of rounds and the rest of the matrix unchanged.

### Result:

-   **Updated KeyMatrix**: The key now contains the number of rounds in the first byte, which will be used by both the encryption and decryption services to determine how many rounds of transformations (XOR, transposition, etc.) to apply.

Role in the Encryption Workflow
-------------------------------

-   **During Encryption**:
    -   The `KeyEmbeddingService` is called before encryption begins to embed the number of rounds into the first byte of the key matrix. This ensures that the encryption service knows how many rounds of transformations to apply.
-   **During Decryption**:
    -   The decryption service reads the first byte of the key matrix to determine how many rounds of decryption (inverse transformations) need to be applied. This guarantees that the decryption process matches the encryption process exactly.

Matrix Operations Explained
---------------------------

-   **Matrix Extraction and Modification**:
    -   The method directly accesses the 4x4 byte matrix from the `KeyMatrix` object and modifies the first byte to store the number of rounds.
-   **Matrix Rebuilding**:
    -   After embedding the number of rounds, the matrix is re-encapsulated into a new `KeyMatrix` object, ensuring the updated matrix is used in subsequent encryption or decryption operations.

Integration in Encryption Service
---------------------------------

-   **Dynamic Round Control**:
    -   The number of rounds is dynamically generated and embedded into the key, providing variability and additional security.
-   **Round Synchronization**:
    -   By embedding the round count directly into the key matrix, the encryption and decryption services remain synchronized. This guarantees that the exact same number of rounds is applied during both encryption and decryption, maintaining consistency across both processes.

